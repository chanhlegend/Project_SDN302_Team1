<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>S·∫£n ph·∫©m</title>
    <link rel="stylesheet" href="/css/viewProfile.css" />
    <script defer src="https://kit.fontawesome.com/a076d05399.js"></script>
  </head>

  <body>
    <%- include('partials/header') %>
    <div class="container">
      <div class="shop-header">
        <div class="shop-container">
          <div class="shop-left">
            <img
              id="shop-avatar"
              src="<%= user.avatar || '/img/avatar.png' %>"
              alt="Shop avatar"
            />
            <div class="shop-name" id="shop-name">
              <%= user.name || 'Ch∆∞a c√≥ t√™n' %>
            </div>
            <div class="shop-address" id="shop-address">
              <%= user.address || 'Ch∆∞a c√≥ ƒë·ªãa ch·ªâ' %>
            </div>
            <div class="shop-actions">
              <button
                class="btn-follow"
                id="follow-button"
                data-id="<%= user._id %>"
              >
                <i class="fas fa-heart"></i> Theo d√µi
              </button>
              <button class="btn-report" onclick="openUserReportModal()">
                <i class="fas fa-flag"></i> B√°o c√°o
              </button>
            </div>
          </div>

          <div class="shop-right">
            <div class="nav-tabs">
              <a href="#" class="tab-item active" data-tab="overview"
                >T·ªîNG QUAN</a
              >
              <a href="#" class="tab-item" data-tab="sold">ƒê√É B√ÅN</a>
              <a href="#" class="tab-item" data-tab="selling">ƒêANG B√ÅN</a>
              <a href="#" class="tab-item" data-tab="reviews">ƒê√ÅNH GI√Å</a>
            </div>

            <div class="tab-content" id="overview">
              <div class="shop-intro">
                <div class="intro-card">
                  <h2>Gi·ªõi thi·ªáu</h2>
                  <p1>
                    Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi c·ª≠a h√†ng c·ªßa ch√∫ng t√¥i! Ch√∫ng t√¥i
                    chuy√™n cung c·∫•p c√°c s·∫£n ph·∫©m ch·∫•t l∆∞·ª£ng cao v·ªõi gi√° c·∫£ ph·∫£i
                    chƒÉng. V·ªõi nhi·ªÅu nƒÉm kinh nghi·ªám trong ng√†nh, ch√∫ng t√¥i t·ª±
                    h√†o mang ƒë·∫øn cho kh√°ch h√†ng nh·ªØng tr·∫£i nghi·ªám mua s·∫Øm tuy·ªát
                    v·ªùi nh·∫•t.
                  </p1>
                  <p2>
                    H√£y kh√°m ph√° c√°c s·∫£n ph·∫©m ƒëang b√°n v√† ƒë·ª´ng ng·∫ßn ng·∫°i li√™n h·ªá
                    v·ªõi ch√∫ng t√¥i n·∫øu b·∫°n c√≥ b·∫•t k·ª≥ c√¢u h·ªèi n√†o.
                  </p2>
                </div>

                <div class="intro-images">
                  <img
                    src="/img/slide1.jpg"
                    alt="Gi·ªõi thi·ªáu 1"
                    class="intro-image"
                  />
                  <img
                    src="/img/slide2.jpg"
                    alt="Gi·ªõi thi·ªáu 2"
                    class="intro-image"
                  />
                  <img
                    src="/img/slide3.jpg"
                    alt="Gi·ªõi thi·ªáu 3"
                    class="intro-image"
                  />
                </div>
              </div>

              <h2 style="margin-top: 20px">S·∫£n ph·∫©m ƒëang b√°n</h2>
              <div class="product-list"></div>
            </div>

            <div class="tab-content" id="sold" style="display: none">
              <h2>S·∫£n ph·∫©m ƒë√£ b√°n</h2>
              <div class="sold-products"></div>
            </div>

            <div class="tab-content" id="selling" style="display: none">
              <h2>S·∫£n ph·∫©m ƒëang b√°n</h2>
              <div class="selling-products"></div>
            </div>

            <div class="tab-content" id="reviews" style="display: none">
              <h2>ƒê√°nh gi√° t·ª´ kh√°ch h√†ng</h2>
              <div class="reviews-list"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="userReportModal" class="modal-container">
      <div class="modal-box">
        <span class="modal-close-btn" onclick="closeUserReportModal()"
          >&times;</span
        >
        <h2 class="modal-title">B√°o C√°o Ng∆∞·ªùi D√πng</h2>
        <form id="userReportForm">
          <label for="reportReason" class="modal-label">L√Ω do b√°o c√°o:</label>
          <select id="reportReason" name="reason" class="modal-select" required>
            <option value="" disabled selected>Ch·ªçn l√Ω do</option>
            <option value="spam">Spam</option>
            <option value="fraud">L·ª´a ƒë·∫£o</option>
            <option value="harassment">Qu·∫•y r·ªëi</option>
            <option value="fake_profile">H·ªì s∆° gi·∫£</option>
            <option value="other">Kh√°c</option>
          </select>

          <label
            for="customReportReason"
            id="customReportLabel"
            class="modal-label"
            style="display: none"
          >
            Nh·∫≠p l√Ω do kh√°c:
          </label>
          <div id="customReasonSection" style="display: none">
            <label class="modal-label">Nh·∫≠p l√Ω do kh√°c:</label>
            <textarea name="details" class="modal-textarea"></textarea>
          </div>

          <label for="reportEvidence" class="modal-label"
            >T·∫£i l√™n ·∫£nh minh ch·ª©ng (t√πy ch·ªçn):</label
          >
          <input
            type="file"
            id="reportEvidence"
            name="evidence"
            class="modal-file-input"
            accept="image/*"
          />

          <button type="submit" class="modal-submit-btn">G·ª≠i B√°o C√°o</button>
        </form>
      </div>
    </div>
    <%- include('partials/footer') %>
  </body>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const userId = window.location.pathname.split("/").pop();
      const followButton = document.getElementById("follow-button");
      followButton.addEventListener("click", handleFollowAction);
      const followingId = followButton.dataset.id;
      const reviewsList = document.querySelectorAll(".reviews-list");

      await fetchUserProfile(userId);
      await fetchProducts(userId);
      await fetchReviews(userId);
      await checkFollowStatus(followingId);

      setupTabs(userId);

      function setupTabs(userId) {
        document.querySelectorAll(".tab-item").forEach((tab) => {
          tab.addEventListener("click", async function (e) {
            e.preventDefault();

            // X√≥a active c√°c tab
            document
              .querySelectorAll(".tab-item")
              .forEach((t) => t.classList.remove("active"));
            this.classList.add("active");

            // ·∫®n t·∫•t c·∫£ n·ªôi dung tab
            document.querySelectorAll(".tab-content").forEach((content) => {
              content.style.display = "none";
            });

            const tabId = this.dataset.tab;
            const activeTab = document.getElementById(tabId);
            if (activeTab) {
              activeTab.style.display = "block";
            }

            // Load d·ªØ li·ªáu t∆∞∆°ng ·ª©ng
            if (tabId === "overview") {
              await fetchProducts(userId);
            } else if (tabId === "sold") {
              await fetchProductsByStatus(userId, "sold");
            } else if (tabId === "selling") {
              await fetchProductsByStatus(userId, "active");
            } else if (tabId === "reviews") {
              await fetchReviews(userId);
            }
          });
        });

        const defaultTab = document.querySelector(".tab-item.active");
        if (defaultTab) {
          defaultTab.click();
        }
      }

      function closeUserReportModal() {
        document.getElementById("userReportModal").style.display = "none";
      }

      document
        .getElementById("reportReason")
        .addEventListener("change", function () {
          const customReason = document.getElementById("customReportReason");
          const customLabel = document.getElementById("customReportLabel");
          if (this.value === "other") {
            customReason.style.display = "block";
            customLabel.style.display = "block";
          } else {
            customReason.style.display = "none";
            customLabel.style.display = "none";
          }
        });

      window.onclick = function (event) {
        const modal = document.getElementById("userReportModal");
        if (event.target === modal) {
          closeUserReportModal();
        }
      };

      async function fetchProductsByStatus(userId, status) {
        try {
          const response = await fetch(
            `http://localhost:3000/productOwner/${userId}/status?status=${status}`
          );
          const data = await response.json();

          if (!response.ok || !data.success) {
            throw new Error(`L·ªói khi l·∫•y danh s√°ch s·∫£n ph·∫©m (${status})`);
          }

          // X√°c ƒë·ªãnh container d·ª±a v√†o status
          const containerClass =
            status === "sold" ? ".sold-products" : ".selling-products";
          const container = document.querySelector(containerClass);

          if (!container) {
            console.error("Kh√¥ng t√¨m th·∫•y container:", containerClass);
            return;
          }

          container.innerHTML = ""; // X√≥a n·ªôi dung c≈©

          if (data.products.length === 0) {
            container.innerHTML = `<p>Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o ${
              status === "sold" ? "ƒë√£ b√°n" : "ƒëang b√°n"
            }.</p>`;
            return;
          }

          data.products.forEach((product) => {
            const productItem = document.createElement("div");
            productItem.classList.add("product-item");
            productItem.innerHTML = `
                <div class="product-image">
                    <img src="${
                      product.image.length > 0
                        ? product.image[0].url
                        : "/images/default.jpg"
                    }" alt="${product.productName}">
                </div>
                <div class="product-info">
                    <h3 class="product-name">${product.productName}</h3>
                    <div class="price-container">
                        <div class="price">${product.price.toLocaleString()}‚Ç´</div>
                        <button class="favorite-btn">ü§ç</button>
                    </div>
                </div>
            `;

            // Th√™m s·ª± ki·ªán click ƒë·ªÉ chuy·ªÉn h∆∞·ªõng sang trang s·∫£n ph·∫©m
            productItem.addEventListener("click", (event) => {
              console.log("Clicked on product:", product._id);
              // N·∫øu click v√†o n√∫t "favorite" th√¨ kh√¥ng chuy·ªÉn trang
              if (!event.target.classList.contains("favorite-btn")) {
                window.location.href = `/product/${product._id}`;
              }
            });

            // X·ª≠ l√Ω s·ª± ki·ªán cho n√∫t y√™u th√≠ch (n·∫øu c√≥)
            const favoriteBtn = productItem.querySelector(".favorite-btn");
            favoriteBtn.addEventListener("click", (event) => {
              event.stopPropagation(); // NgƒÉn ch·∫∑n s·ª± ki·ªán click lan ra ngo√†i
              toggleFavorite(event, favoriteBtn);
            });

            container.appendChild(productItem);
          });
        } catch (error) {
          console.error(`L·ªói khi l·∫•y s·∫£n ph·∫©m (${status}):`, error);
        }
      }

      async function fetchUserProfile(userId) {
        try {
          const response = await fetch(`/user/profile/${userId}`);
          const user = await response.json();
          if (!response.ok) throw new Error(user.message);

          document.getElementById("shop-avatar").src =
            user.avatar || "/images/shop-avatar.jpg";
          document.getElementById("shop-name").textContent =
            user.username || "Ch∆∞a c√≥ t√™n";
          document.getElementById("shop-address").textContent =
            user.address || "Ch∆∞a c√≥ ƒë·ªãa ch·ªâ";
        } catch (error) {
          console.error("L·ªói khi l·∫•y th√¥ng tin ng∆∞·ªùi d√πng:", error);
        }
      }

      async function fetchProducts(userId) {
        try {
          const response = await fetch(`/productOwner/${userId}`);
          const data = await response.json();
          if (!response.ok || !data.products.length)
            throw new Error("Kh√¥ng c√≥ s·∫£n ph·∫©m ho·∫∑c l·ªói API");

          const productListContainer = document.querySelector(".product-list");
          productListContainer.innerHTML = "";

          data.products.forEach((product) => {
            const productItem = document.createElement("div");
            productItem.classList.add("product-item");
            productItem.innerHTML = `
                            <div class="product-image">
                                <img src="${
                                  product.image.length > 0
                                    ? product.image[0].url
                                    : "/images/default.jpg"
                                }" alt="${product.productName}">
                            </div>
                            <div class="product-info">
                                <h3 class="product-name">${
                                  product.productName
                                }</h3>
                                 <div class="price-container">
                                    <div class="price">${product.price.toLocaleString()}‚Ç´</div>
                                    <button class="favorite-btn" onclick="toggleFavorite(this)">ü§ç</button>
                                 </div>
                            </div>
                        `;

            productItem.addEventListener("click", (event) => {
              console.log("Clicked on product:", product._id);
              // N·∫øu click v√†o n√∫t "favorite" th√¨ kh√¥ng chuy·ªÉn trang
              if (!event.target.classList.contains("favorite-btn")) {
                window.location.href = `/product/${product._id}`;
              }
            });
            productListContainer.appendChild(productItem);
          });
        } catch (error) {
          console.error("L·ªói khi l·∫•y danh s√°ch s·∫£n ph·∫©m:", error);
        }
      }

      async function fetchReviews(userId) {
        try {
          const response = await fetch(`/evaluate/${userId}`);
          const data = await response.json();

          if (!response.ok || !data || !Array.isArray(data.evaluates)) {
            throw new Error(
              "D·ªØ li·ªáu ƒë√°nh gi√° kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng c√≥ ƒë√°nh gi√°."
            );
          }

          reviewsList.forEach((reviewContainer) => {
            reviewContainer.innerHTML = "";

            if (data.evaluates.length === 0) {
              reviewContainer.innerHTML = "<p>Ch∆∞a c√≥ ƒë√°nh gi√° n√†o.</p>";
              return;
            }

            data.evaluates.forEach((review) => {
              const reviewerName =
                review.evaluaterId?.name || "Ng∆∞·ªùi d√πng ·∫©n danh";

              const reviewItem = document.createElement("div");
              reviewItem.classList.add("review-box"); // Th√™m l·ªõp CSS t·∫°o khung ri√™ng

              let starsHTML = "";
              for (let i = 1; i <= 5; i++) {
                starsHTML += `<span class="star ${
                  i <= review.star ? "filled" : "empty"
                }">‚òÖ</span>`;
              }

              reviewItem.innerHTML = `
          <div class="review-container">
              <img class="review-avatar" src="${
                review.evaluaterId?.avatar || "/img/avatar.png"
              }" alt="Avatar">
              <div class="review-content">
                  <div class="review-header">
                      <strong>${reviewerName}</strong>
                      <span class="rating">${starsHTML}</span>
                  </div>
                  <p class="review-comment">${
                    review.comment || "Kh√¥ng c√≥ b√¨nh lu·∫≠n."
                  }</p>
                  <div class="review-product">
                      <span>S·∫£n ph·∫©m ƒë∆∞·ª£c ƒë√°nh gi√°:</span>
                      <div class="product-info">
                          <img class="product-image-evaluate" src="${
                            review.productId?.image[0]?.url ||
                            "/img/default-product.png"
                          }" alt="S·∫£n ph·∫©m">
                          <p class="product-name">${
                            review.productId?.productName ||
                            "S·∫£n ph·∫©m kh√¥ng x√°c ƒë·ªãnh"
                          }</p>
                      </div>
                  </div>
              </div>
          </div>
        `;
              reviewContainer.appendChild(reviewItem);
            });
          });
        } catch (error) {
          console.error("L·ªói khi l·∫•y ƒë√°nh gi√°:", error);
        }
      }

      async function checkFollowStatus(followingId) {
        try {
          const response = await fetch(`/follow/check-follow/${followingId}`, {
            credentials: "include",
          });

          if (!response.ok) throw new Error("Kh√¥ng th·ªÉ ki·ªÉm tra tr·∫°ng th√°i");

          const data = await response.json();
          updateFollowButton(data.isFollowing);
        } catch (error) {
          console.error("L·ªói khi ki·ªÉm tra tr·∫°ng th√°i:", error);
        }
      }
    });

    function updateFollowButton(isFollowing) {
      const followButton = document.getElementById("follow-button");
      if (!followButton) return;

      if (isFollowing) {
        followButton.innerHTML = '<i class="fas fa-check"></i> ƒêang theo d√µi';
        followButton.classList.add("following");
        followButton.style.backgroundColor = "#6c757d";
      } else {
        followButton.innerHTML = '<i class="fas fa-heart"></i> Theo d√µi';
        followButton.classList.remove("following");
        followButton.style.backgroundColor = "#dc3545";
      }
    }

    async function handleFollowAction() {
      const followButton = document.getElementById("follow-button");
      const followingId = followButton.dataset.id;
      const isFollowing = followButton.classList.contains("following");

      try {
        followButton.disabled = true;
        followButton.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';

        const endpoint = isFollowing ? "/follow/unfollower" : "/follow/";

        const response = await fetch(endpoint, {
          method: "POST",
          credentials: "include",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ followingId }),
        });

        const result = await response.json();

        if (!response.ok) throw new Error(result.message || "L·ªói h·ªá th·ªëng");

        // C·∫≠p nh·∫≠t UI
        updateFollowButton(!isFollowing);
      } catch (error) {
        alert(error.message);
        console.error("L·ªói khi thao t√°c theo d√µi:", error);
      } finally {
        followButton.disabled = false;
      }
    }

    function toggleFavorite(button) {
      if (button.textContent === "ü§ç") {
        button.textContent = "‚ù§Ô∏è";
      } else {
        button.textContent = "ü§ç";
      }
    }

    function openUserReportModal() {
      document.getElementById("userReportModal").style.display = "flex";
      const form = document.getElementById("userReportForm");
      const customSection = document.getElementById("customReasonSection");
      const reasonSelect = document.getElementById("reportReason");

      // X·ª≠ l√Ω hi·ªÉn th·ªã ph·∫ßn nh·∫≠p l√Ω do t√πy ch·ªânh
      reasonSelect.addEventListener("change", () => {
        customSection.style.display =
          reasonSelect.value === "other" ? "block" : "none";
      });

      form.onsubmit = async function (event) {
        event.preventDefault();
        const formData = new FormData(form);
        const userId = window.location.pathname.split("/").pop();

        formData.append("sellerId", userId);

        try {
          const response = await fetch(`/report/`, {
            method: "POST",
            body: formData,
            credentials: "include",
          });

          const result = await response.json();
          if (!response.ok) throw new Error(result.message || "L·ªói h·ªá th·ªëng");

          alert("B√°o c√°o th√†nh c√¥ng!");
          form.reset();
          closeUserReportModal();
        } catch (error) {
          alert(error.message);
        }
      };
    }

    function closeUserReportModal() {
      document.getElementById("userReportModal").style.display = "none";
    }

    window.onclick = function (event) {
      const modal = document.getElementById("userReportModal");
      if (event.target === modal) {
        closeUserReportModal();
      }
    };

    document
      .getElementById("reportReason")
      .addEventListener("change", function () {
        const customReason = document.getElementById("customReportReason");
        const customLabel = document.getElementById("customReportLabel");
        if (this.value === "other") {
          customReason.style.display = "block";
          customLabel.style.display = "block";
        } else {
          customReason.style.display = "none";
          customLabel.style.display = "none";
        }
      });
  </script>
</html>
